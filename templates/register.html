{% extends 'base.html' %}
{% load static %}


{% block content1 %}
    <link rel="stylesheet" href="{% static 'styles/register.css' %}">
    <!-- ajax link  -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <form method="POST" onsubmit="return validateForm()" action="{% url 'register' %}">
    {% csrf_token %}
    <div class="form-group">
        <label for="exampleInputUsername">Username</label>
        <input name="username" type="text" onkeyup="checkUsernameAvailability()" class="form-control" id="username" aria-describedby="userNameHelp" placeholder="Enter username" required>
        <span id="usernameMessage"></span>
      </div>

    <div class="form-group">
        <label for="exampleInputFirstname">Firstname</label>
        <input name="firstName" type="text" class="form-control" id="firstname" aria-describedby="firstnameHelp" placeholder="Enter first name" required>
    </div>

    <div class="form-group">
        <label for="exampleInputLastname">Lastname</label>
        <input name="lastName" type="text" class="form-control" id="lastname" aria-describedby="lastNameHelp" placeholder="Enter last name" required>
    </div>

    <div class="form-group">
      <label for="exampleInputEmail1">Email address</label>
      <input name="email" onkeyup="checkEmail()" type="email" class="form-control" id="email" aria-describedby="emailHelp" placeholder="Enter email" required>
      <span id="emailError"></span>
      <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>
    </div>

    <div class="form-group">
      <label for="exampleInputPassword1">Password</label>
      <input name="password" type="password" onkeyup="checkPassword()" class="form-control" id="password" placeholder="Password" required>
      <span id="passwordError"></span>
    </div>

    <div class="form-group">
        <label for="exampleInputPassword1">Password</label>
        <input name="password1" type="password" onkeyup="checkPasswordEqual()" class="form-control" id="confirmPassword" placeholder="Password" required>
    </div>

    <div class="form-check">
      <input name="terms" type="checkbox" class="form-check-input" id="agree">
      <label class="form-check-label" for="exampleCheck1">Check me out</label>
    </div>

    <button type="submit" class="btn btn-primary">Submit</button>

    </form>

    <script>
      // checking username with ajax 
      let usernamevalid = true;
      function checkUsernameAvailability() {
            const username = document.getElementById("username").value;
            const usernameMessage = document.getElementById("usernameMessage");

            if (username.length < 3) {
                usernameMessage.textContent = 'Username is too short.';
                usernameMessage.style.color='red';
                usernamevalid = false;
                return;
            }

            // Make an AJAX request to check username availability
            const xhr = new XMLHttpRequest();
            xhr.open('GET', `/check_username/?username=${username}`, true);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        if (data.exists) {
                            usernameMessage.textContent = 'Username is already taken.';
                            usernameMessage.style.color='red';
                            usernamevalid = false;
                            // console.log(usernamevalid);
                        } else {
                            usernameMessage.textContent = 'Username is available.';
                            usernameMessage.style.color='green';
                            usernamevalid = true;
                            // console.log(usernamevalid);
                        }
                    } else {
                        console.error('An error occurred:', xhr.status, xhr.statusText);
                        usernameMessage.textContent = 'Error checking username availability.';
                    }
                }
            };

            xhr.send();
      }     
      // checking email validity 
      let emailvalidity = true;
      function checkEmail(){
        let email = document.getElementById('email').value;
        let emailError = document.getElementById('emailError');
        let emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
          if(!email.match(emailRegex)) {
              emailError.textContent = "Please enter a valid email address.";
              emailError.style.color = 'red';
              emailvalidity=false;
          }else{
              emailError.textContent = "valid email adress";
              emailError.style.color = 'green';
              emailvalidity=true;
          }
        }
        // checking password validity 
        let passwordvalidity = true;
        function checkPassword(){
          let password = document.getElementById("password").value;
          let passwordError = document.getElementById("passwordError");         
          if(password.length<5){
              passwordError.textContent = "password must be 5 characters long";
              passwordError.style.color = "red";
              passwordvalidity=false;
          }else{
              passwordError.textContent = "password is valid";
              passwordError.style.color = "green";
              passwordvalidity = true;
          }
        }
        let passwordEquality = true;
        function checkPasswordEqual(){
              let pasword = document.getElementById("password");
              let confirmPassword = document.getElementById("confirmPassword");
              if((password.value.length < 5) || (password.value !== confirmPassword.value)){
                  confirmPassword.style.backgroundColor="red";
                  passwordEquality=false;
              }else{
                  confirmPassword.style.backgroundColor="green";
                  passwordEquality=true;
              }
        }
        // form validating 
        function validateForm(){
          let agree = document.getElementById("agree").checked;
          let valid = usernamevalid && emailvalidity && passwordvalidity && passwordEquality && agree;
          if(!valid){
            window.alert('please fill out the form correctly');
          }
          return valid;
        }
    </script>
{% endblock %}